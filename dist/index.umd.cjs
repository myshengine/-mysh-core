(function(a,m){typeof exports=="object"&&typeof module<"u"?m(exports):typeof define=="function"&&define.amd?define(["exports"],m):(a=typeof globalThis<"u"?globalThis:a||self,m(a.GamzixCore={}))})(this,function(a){"use strict";class m{constructor(){this._groupId="",this.withDisabled=!1}get groupId(){return this._groupId}setContext(t,e){this._groupId=t,this._entityStorage=e}async run(t,e,s){this.externalFilter=e,this.withDisabled=s,await this.execute(t)}filter(t){const e={includes:[...t.includes,...this.externalFilter.includes||[]],excludes:[...t.excludes||[],...this.externalFilter.excludes||[]]};return this._entityStorage.filter(e,this.withDisabled)}cleanFilter(t){return this._entityStorage.filter(t,this.withDisabled)}getDependency(t){return c.instance.get(t,this.groupId)}}class p{static uuid(){return Date.now().toString(36)+Math.random().toString(36).slice(2)}static debounce(t,e=0){let s=null;return(...i)=>{clearTimeout(s),s=setTimeout(()=>{t(...i)},e)}}}class T{constructor(){this._uuid=p.uuid()}get uuid(){return this._uuid}sorted(t){const e=this.setup(t),s=1e4;return e.forEach((i,n)=>{i.withDisabled===void 0&&(i.withDisabled=!1),i.includes===void 0&&(i.includes=[]),i.excludes===void 0&&(i.excludes=[]),i.repeat||(i.repeat=1),i.canExecute||(i.canExecute=()=>!0),i.order===void 0&&(i.order=(n+1)*s)}),e.sort((i,n)=>(i.order||0)-(n.order||0))}registerGroupDependencies(){const t=this.setupDependencies();c.instance.registerModule(this.uuid,t)}provide(t,e){return{system:t,data:e}}setupDependencies(){return[]}}class c{constructor(){this.providers=new Map,this.instances=new Map,this.systemTokens=[],this.providers.set("global",new Map),this.instances.set("global",new Map)}static get instance(){return c._instance||(c._instance=new c),c._instance}registerModule(t,e){this.providers.has(t)||(this.providers.set(t,new Map),this.instances.set(t,new Map));const s=this.providers.get(t);for(const i of e)s.set(i.provide,i)}registerGlobal(t){this.registerModule("global",t)}get(t,e="global"){var r;let s=((r=this.providers.get(e))==null?void 0:r.get(t))??this.providers.get("global").get(t);if(!s)throw new Error(`Provider for token ${t.toString()} not found`);const i=this.instances.get(e==="global"?"global":e);if(i.has(t))return i.get(t);const n="useClass"in s?new s.useClass:s.useFactory();return i.set(t,n),n}memorizeSystem(t,e,s){this.systemTokens.push({system:t,token:e,key:s})}getDependencyForSystem(t,e){if(!("injectHere"in e))return;const s=[];for(const i of this.systemTokens)e instanceof i.system&&s.push({token:i.token,key:i.key});s.forEach(i=>{var n;if(i.key in e){const r=((n=this.providers.get(t))==null?void 0:n.get(i.token))??this.providers.get("global").get(i.token);if(!r)return;let o=this.get(i.token,t);r.immutable&&(o=new Proxy(o,{get:(u,d)=>{const _=u[d];return _ instanceof Object?new Proxy(_,{}):_},set:()=>(console.warn("Direct state mutation is not allowed. Use setState instead."),!1)})),Object.defineProperty(e,i.key,{value:o,enumerable:!0,configurable:!1})}})}}function k(h){if(!h)throw new Error("Token must be provided to @Inject decorator when not using reflect-metadata");return function(t,e){let s="global";if(t instanceof m){Object.defineProperty(t,"injectHere",{value:"injectHere",enumerable:!1,configurable:!1}),Object.defineProperty(t,e,{value:null}),c.instance.memorizeSystem(t.constructor,h,e);return}t instanceof T&&(s=t.uuid),Object.defineProperty(t,e,{get:()=>c.instance.get(h,s),enumerable:!0,configurable:!1})}}class E{constructor(){this._cache=new Map}get(t){let e=this._cache.get(t);return e||(e=new t,this._cache.set(t,e)),e}}const j=(h,t)=>e=>!(!e.hasComponents(h)||t&&e.hasComponents(t));class ${constructor(t=[]){this._entities=t}get count(){return this._entities.length}get items(){return this._entities}forEach(t){for(let e=0;e<this._entities.length;e++)t(this._entities[e],e)}async sequential(t){let e=0;for(const s of this._entities)await t(s,e),e+=1}async parallel(t){const e=this._entities.map(t);await Promise.all(e)}}const C=class C{static increment(t){const e=this._componentFrequency.get(t)??0;this._componentFrequency.set(t,e+1)}static decrement(t){const e=this._componentFrequency.get(t)??0;e>1?this._componentFrequency.set(t,e-1):this._componentFrequency.delete(t)}static rarity(t){return this._componentFrequency.get(t)??0}static sortByRarity(t){return[...t].sort((e,s)=>this.rarity(e)-this.rarity(s))}};C._componentFrequency=new Map;let l=C;class v{constructor(){this._entities=new Map}addEntity(t){const{uuid:e,name:s}=t;if(this._entities.has(e))throw new Error(`Entity with UUID [${s}-${e}] already exists in the storage.`);this._entities.set(e,t)}removeEntity(t){const e=this._entities.get(t);if(e)return this._entities.delete(t),e}getEntity(t){return this._entities.get(t)}getAllEntities(){return Array.from(this._entities.values())}getActiveEntities(){return Array.from(this._entities.values()).filter(t=>t.active)}getInactiveEntities(){return Array.from(this._entities.values()).filter(t=>!t.active)}filter(t,e){let s=e?this.getAllEntities():this.getActiveEntities();if(t.excludes||(t.excludes=[]),t!=null&&t.includes.length||t!=null&&t.excludes.length){const i=l.sortByRarity(t.includes),n=t.excludes.length?l.sortByRarity(t.excludes):void 0,r=j(i,n);s=s.filter(r)}return new $(s)}}class M{constructor(t,e){this._systemsContainer=t,this._entityStorage=e,this._isPaused=!1,this._resumePromise=null,this._resolveResume=null,this._queue=[],this._groups=[]}get groups(){return this._groups}async execute(t,e){var s;for(this._queue=this.setExecutionQueue(t,e);this._queue.length>0;){this._isPaused&&await this.waitForResume();const i=this._queue.shift();if(i){const n=i.canExecute();if(((s=this._currentGroup)==null?void 0:s.uuid)!==i.groupId&&(this._currentGroup=this._groups.find(r=>r.uuid===i.groupId)),n){const r={includes:i.includes,excludes:i.excludes};i.system.setContext(i.groupId,this._entityStorage),c.instance.getDependencyForSystem(i.groupId,i.system),await i.system.run(i.data,r,i.withDisabled)}}}}stop(){this._queue=[]}pause(){this._isPaused||(this._isPaused=!0)}resume(){this._isPaused&&(this._isPaused=!1,this._resolveResume&&(this._resolveResume(),this._resolveResume=null,this._resumePromise=null))}waitForResume(){return this._resumePromise||(this._resumePromise=new Promise(t=>{this._resolveResume=t})),this._resumePromise}setExecutionQueue(t,e){const s=[];return e.forEach(i=>{if(i.canExecute(t)){const n=i.group.sorted(t),r=i.group.uuid;this._groups.push(i.group),n.forEach(o=>{const u=this._systemsContainer.get(o.instance.system);for(let d=0;d<o.repeat;d++)s.push({...o,data:o.instance.data,groupId:r,system:u})})}}),s}}class f{constructor(t,e){this._systemStorage=t,this._entityStorage=e,this._pairs=new Map,this._disposables=[],this._executors=[]}static factory(t,e){t.forEach(s=>{s.executions.forEach(i=>{e.inject(s.signal,i)})})}static override(t,e){const s=new Map;for(const i of t)s.set(i.signal,{...i,executions:[...i.executions]});for(const i of e)if(s.has(i.signal)){const n=s.get(i.signal),r=new Map;for(const o of n.executions)r.set(o.order??r.size+1,{...o});for(const o of i.executions)o.order!==void 0&&r.has(o.order)?r.set(o.order,{...o}):r.set(o.order??r.size+1,{...o});n.executions=Array.from(r.values()).sort((o,u)=>o.order-u.order)}else s.set(i.signal,{...i});return Array.from(s.values())}inject(t,e){const s=this._pairs.get(t)||[],i=new e.group;i.registerGroupDependencies();const n=e.canExecute?e.canExecute:u=>!0,r={group:i,canExecute:n,order:e.order?e.order:0};s.push(r),s.forEach((u,d)=>{u.order||(u.order=(d+1)*1e4)});const o=s.sort((u,d)=>(u.order||0)-(d.order||0));this._pairs.set(t,o)}dispatch(t,e){t.dispatch(e)}subscribe(){Array.from(this._pairs.keys()).forEach(e=>{const s=e.subscribe(async i=>{const n=this._pairs.get(e)||[],r=new M(this._systemStorage,this._entityStorage);this._executors.push(r),await r.execute(i,n);const o=this._executors.indexOf(r);this._executors.splice(o,1)});this._disposables.push(s)})}unsubscribe(){this._disposables.forEach(t=>t.dispose()),this._pairs.clear(),this.stop(),this._executors.length=0}stop(){this._executors.forEach(t=>t.stop())}pause(){this._executors.forEach(t=>t.pause())}resume(){this._executors.forEach(t=>t.resume())}}class A{constructor(t,e,s,i){this._uuid=t,this._timerController=e,this._onComplete=s,this._duration=i,this._elapsedTime=0}get uuid(){return this._uuid}update(t){this._elapsedTime+=t*1e3,this._elapsedTime>=this._duration&&(this._onComplete(),this._timerController.clear(this.uuid))}}class D{constructor(t,e,s){this._uuid=t,this._onComplete=e,this._duration=s,this._elapsedTime=0}get uuid(){return this._uuid}onComplete(){return this._onComplete}update(t){this._elapsedTime+=t*1e3,this._elapsedTime>=this._duration&&(this._elapsedTime=0,this._onComplete())}}class F{constructor(){this.promise=new Promise((t,e)=>{this.resolve=t,this.reject=e})}static resolveAll(t,e){t.forEach(s=>s.resolve(e))}static rejectAll(t,e){t.forEach(s=>s.reject(e))}static all(t){return Promise.all(t.map(e=>e.promise))}static allSettled(t){return Promise.allSettled(t.map(e=>e.promise))}static race(t){return Promise.race(t.map(e=>e.promise))}}class y{constructor(){this._updatables=new Map}setTimeout(t,e){const s=p.uuid(),i=new A(s,this,t,e);return this._updatables.set(s,i),s}setInterval(t,e){const s=p.uuid(),i=new D(s,t,e);return this._updatables.set(s,i),s}sleep(t){const e=new F,s=this.setTimeout(()=>e.resolve(),t);return{id:s,wait:async()=>await e.promise,resolve:()=>{e.resolve(),this.clear(s)}}}clear(t){this._updatables.has(t)&&this._updatables.delete(t)}update(t){Array.from(this._updatables.values()).forEach(s=>s.update(t))}}class g{constructor(t="Signal"){this._name=t,this.listeners=[],this._uuid=p.uuid()}get name(){return this._name}get uuid(){return this._uuid}subscribe(t){return this.listeners.push({callback:t,once:!1}),{dispose:()=>{this.unsubscribe(t)}}}once(t){return this.listeners.push({callback:t,once:!0}),{dispose:()=>{this.unsubscribe(t)}}}unsubscribe(t){this.listeners=this.listeners.filter(e=>e.callback!==t)}dispatch(t){const e=[];for(const s of this.listeners)s.callback(t),s.once&&e.push(s.callback);e.length>0&&(this.listeners=this.listeners.filter(s=>!e.includes(s.callback)))}}const P=new g;class S{constructor(){this._lastTime=0,this._paused=!1,this._speedMultiplier=1,this._onUpdate=[],this.animate=t=>{if(!this._paused){if(this._lastTime!==0){const e=(t-this._lastTime)/1e3;this.update(e)}this._lastTime=t,requestAnimationFrame(this.animate)}}}init(){requestAnimationFrame(this.animate)}addUpdateCallback(t){this._onUpdate.push(t)}removeUpdateCallback(t){this._onUpdate=this._onUpdate.filter(e=>e!==t)}pause(t){this._paused=t}setSpeedMultiplier(t){this._speedMultiplier=t}update(t){if(this._paused)return;const e=t*this._speedMultiplier;this._onUpdate.forEach(s=>s(e)),P.dispatch({deltaTime:t,speedMultiplier:this._speedMultiplier,multipliedDelta:e})}}class U{init(){this.registerServices();const t=c.instance.get(S),e=c.instance.get(y);t.addUpdateCallback(s=>{e.update(s)}),t.init()}listen(t){const e=c.instance.get(f);f.factory(t,e),e.subscribe()}registerGlobalServices(t){c.instance.registerGlobal(t)}registerServices(){const t=new v,e=new E,s=new S,i=new y,n=new f(e,t);this.registerGlobalServices([{provide:v,useFactory:()=>t},{provide:E,useFactory:()=>e},{provide:S,useFactory:()=>s},{provide:y,useFactory:()=>i},{provide:f,useFactory:()=>n}])}}const b=new g,w=new g,x=new g;class G{constructor(t,e){this._states=new Map,this._started=!1,this._name=t.name,this._hooks=e,this._store=t.store,this._guards=t.guards??{},this._initialState=t.initialState,this.setupStates(t.states)}get name(){return this._name}get currentState(){return this._currentState}get currentStateName(){return this._currentState.name}get previousState(){return this._prevStateName}get states(){return Array.from(this._states.values())}get store(){return this._store}listen(t){const e=[];this._states.forEach(s=>{s.onEnter&&e.push(this.formatGroups(s,s.onEnter,b)),s.onExit&&e.push(this.formatGroups(s,s.onExit,w)),s.onTransition&&e.push(this.formatGroups(s,s.onTransition,x))}),e.forEach(s=>{s.executions.forEach(i=>{t.inject(s.signal,i)})})}formatGroups(t,e,s){const i=r=>r.fsmName!==this._name?!1:this._currentState?this.currentStateName===t.name:!1,n=e.map(r=>({group:r,canExecute:o=>i(o)}));return{signal:s,executions:n}}start(t){this._started||(this._started=!0,this.setupInitialState(t??this._initialState))}canTransitTo(t){return Object.values(this._currentState.transitions).some(e=>e===t)}canSend(t){return!!(this._currentState.transitions[t]??this._currentState.transitions["*"])}isIn(t){return this._currentState.name===t}transitTo(t){var s,i,n,r,o,u,d,_;if(!this.canTransitTo(t))throw new Error(`Cannot transit from ${this._currentState.name} to ${t}`);if(this.isGuardBlocked(t))return;(s=this._currentState.subMachine)==null||s.stop(),w.dispatch({fsmName:this._name,from:this._currentState.name,to:t,store:this._store}),(n=(i=this._hooks)==null?void 0:i.onExitState)==null||n.call(i,this._currentState.name,this._store),x.dispatch({fsmName:this._name,from:this._currentState.name,to:t,store:this._store});const e=this._states.get(t);if(!e)throw new Error(`[FSM:${this._name}] Target state "${t}" not found`);this._prevStateName=this._currentState.name,this._currentState=e,(o=(r=this._hooks)==null?void 0:r.onAnyTransition)==null||o.call(r,this._prevStateName,t,this._store),(d=(u=this._hooks)==null?void 0:u.onEnterState)==null||d.call(u,this._currentState.name,this._store),b.dispatch({fsmName:this._name,from:this._currentState.name,to:t,store:this._store}),(_=this._currentState.subMachine)==null||_.start()}send(t){var s,i,n,r,o;const e=this._currentState.transitions[t]??this._currentState.transitions["*"];if(!e)throw(i=(s=this._hooks)==null?void 0:s.onUnhandledEvent)==null||i.call(s,t,this._currentState.name,this._store),new Error(`[FSM:${this._name}] No transition for event "${t}" in state "${this._currentState.name}"`);(o=(r=(n=this._hooks)==null?void 0:n.onEvent)==null?void 0:r[t])==null||o.call(r,this._store),this.transitTo(e)}stop(){var t,e,s;(t=this._currentState.subMachine)==null||t.stop(),w.dispatch({fsmName:this._name,from:this._currentState.name,to:this._currentState.name,store:this._store}),(s=(e=this._hooks)==null?void 0:e.onExitState)==null||s.call(e,this._currentState.name,this._store),this._started=!1}isGuardBlocked(t){var i,n,r;const e=(i=Object.entries(this._currentState.transitions).find(([,o])=>o===t))==null?void 0:i[0],s=e?this._guards[e]:void 0;return s&&!s(this._store)?((r=(n=this._hooks)==null?void 0:n.onBlockedByGuard)==null||r.call(n,this._currentState.name,t,this._store),!0):!1}setupStates(t){for(const e of t)this._states.set(e.name,e)}setupInitialState(t){var s,i,n;const e=this._states.get(t);if(!e)throw new Error(`State ${t} not found`);this._currentState=e,(i=(s=this._hooks)==null?void 0:s.onEnterState)==null||i.call(s,this._currentState.name,this._store),b.dispatch({fsmName:this._name,from:this._currentState.name,to:this._currentState.name,store:this._store}),(n=this._currentState.subMachine)==null||n.start()}}class I{constructor(){this._items=[]}get items(){return this._items}set(t){this._items.push(t)}get(t){return this._items.find(e=>e instanceof t)}has(t){return!!this.get(t)}delete(t){const e=this.get(t);return e&&(this._items=this.items.filter(s=>s.constructor!==t)),!!e}clear(){this._items.length=0}}class O{constructor(t,e="Entity"){this._uuid=t,this._name=e,this._active=!0,this._components=new I,this._disabledComponents=new I}get uuid(){return this._uuid}get name(){return this._name}set name(t){this._name=t}get active(){return this._active}set active(t){this._active=t}get components(){return this._components.items}get disabledComponents(){return this._disabledComponents.items}addComponent(t,e=!0){const s=this.extractConstructor(t);if(this._components.has(s)||this._disabledComponents.has(s))throw new Error(`Component of type ${s.name} already exists in entity [${this._name}-${this._uuid}]`);e?(this._components.set(t),l.increment(s)):(this._disabledComponents.set(t),l.decrement(s))}getComponent(t){const e=this._components.get(t);if(!e)throw new Error(`Component of type ${t.name} is not found in [${this.name}-${this.uuid}].`);return e}hasComponents(t){return t.every(e=>!!this._components.get(e))}removeComponent(t){let e;if(this._components.has(t)?(e=this._components.get(t),this._components.delete(t)):this._disabledComponents.has(t)&&(e=this._disabledComponents.get(t),this._disabledComponents.delete(t)),!e)throw new Error(`Component type ${t.name} does not exist in entity [${this._name}-${this._uuid}]`);return l.decrement(t),e}enableComponent(t){if(!this._disabledComponents.has(t))throw new Error(`Cannot enable component of type ${t.name} - it does not exist or is already enabled.`);const e=this._disabledComponents.get(t);this._disabledComponents.delete(t),this._components.set(e),l.increment(t)}disableComponent(t){if(!this._components.has(t))throw new Error(`Cannot disable component of type ${t.name} - it does not exist or is already disabled.`);const e=this._components.get(t);this._components.delete(t),this._disabledComponents.set(e),l.decrement(t)}disableAllComponents(){for(const t of this._components.items)this._disabledComponents.set(t),l.decrement(t.constructor);this._components.clear()}enableAllComponents(){for(const t of this._disabledComponents.items)this._components.set(t),l.increment(t.constructor);this._disabledComponents.clear()}isSatisfiedFilter(t){const e=t.includes||[],s=t.excludes||[];return this.hasComponents(e)&&(!s.length||!this.hasComponents(s))}extractConstructor(t){return t.constructor}}class q{constructor(t,e={}){this._data=t,this.listeners=new Set,this.middleware=[],this.validators=[],this.history=[],this.historyIndex=-1,this.middleware=e.middleware||[],this.validators=e.validators||[],this.historySize=e.historySize||10,this.pushToHistory(this._data)}get state(){return new Proxy(this._data,{get:(t,e)=>{const s=t[e];return s instanceof Object?new Proxy(s,{}):s},set:()=>(console.warn("Direct state mutation is not allowed. Use setState instead."),!1)})}subscribe(t){return this.listeners.add(t),()=>this.listeners.delete(t)}setState(t){const e=t(this.state);for(const i of this.validators){const n=i(e);if(n!==!0)throw new Error(typeof n=="string"?n:"Validation failed")}let s=this.middleware.length?this._data:{...this._data,...e};for(const i of this.middleware)s=i(s,e,this.applyUpdate);this._data=s,this.pushToHistory(s),this.notifyListeners()}transaction(t){const e=this.state;try{this._data=t.apply(this.state),this.pushToHistory(this._data),this.notifyListeners()}catch(s){throw this._data=t.rollback(e),this.notifyListeners(),s}}undo(){return this.historyIndex>0?(this.historyIndex--,this._data=this.history[this.historyIndex],this.notifyListeners(),!0):!1}redo(){return this.historyIndex<this.history.length-1?(this.historyIndex++,this._data=this.history[this.historyIndex],this.notifyListeners(),!0):!1}reset(t={}){this._data=t,this.history=[],this.historyIndex=-1,this.pushToHistory(this._data),this.notifyListeners()}applyUpdate(t,e){return{...t,...e}}pushToHistory(t){this.historyIndex++,this.history=this.history.slice(0,this.historyIndex).concat([{...t}]),this.history.length>this.historySize&&(this.history=this.history.slice(-this.historySize),this.historyIndex=this.history.length-1)}notifyListeners(){this.listeners.forEach(t=>t(this.state))}}a.ComponentsRaritySorter=l,a.DeferredPromise=F,a.Entity=O,a.EntityStorage=v,a.Executor=M,a.FSM=G,a.Inject=k,a.MyshApp=U,a.OnStateEnterSignal=b,a.OnStateExitSignal=w,a.OnStateTransitionSignal=x,a.OnUpdateSignal=P,a.ServiceContainer=c,a.Signal=g,a.SignalController=f,a.Store=q,a.System=m,a.SystemGroup=T,a.SystemsContainer=E,a.TimerController=y,a.UpdateLoop=S,a.Utils=p,Object.defineProperty(a,Symbol.toStringTag,{value:"Module"})});
